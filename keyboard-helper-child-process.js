var c=Object.defineProperty,g=(t,e,s)=>e in t?c(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,r=(t,e,s)=>g(t,typeof e!="symbol"?e+"":e,s);import{createRequire as b}from"node:module";const l=b(import.meta.url)("koffi");class u{constructor(){r(this,"lib"),r(this,"callback"),r(this,"isMonitoring",!1),r(this,"pressingKeys",[]),r(this,"processEventsInterval",null),r(this,"libUpdateTargetShortcuts"),r(this,"libResetPressingKeycodes"),r(this,"libStartMonitor"),r(this,"libProcessEvents"),r(this,"libStopMonitor"),r(this,"libSetWatcherInterval"),r(this,"libGetKeyboardLayoutInfo"),this.initializeLibrary(),this.setupMessageHandlers()}initializeLibrary(){try{const e=process.env.KEYBOARD_HELPER_LIB_PATH;if(!e)throw new Error("KEYBOARD_HELPER_LIB_PATH environment variable not set");this.lib=l.load(e);const s=l.proto("bool KeyboardCallback(int32_t, int32_t, int32_t, char*)");this.libUpdateTargetShortcuts=this.lib.func("updateTargetShortcuts","void",["char*"]),this.libResetPressingKeycodes=this.lib.func("resetPressingKeycodes","void",[]),this.libStartMonitor=this.lib.func("startMonitor","bool",[l.pointer(s)]),this.libProcessEvents=this.lib.func("processEvents","void",[]),this.libStopMonitor=this.lib.func("stopMonitor","void",[]),this.libSetWatcherInterval=this.lib.func("setWatcherInterval","void",["double"]),this.libGetKeyboardLayoutInfo=this.lib.func("getKeyboardLayoutInfo","string",["bool"]),this.callback=l.register((i,y,h,p)=>(setImmediate(()=>{try{if(i===-9999&&y===-9999&&h===-9999){this.pressingKeys=[],this.sendMessage({type:"log",payload:{message:"Keyboard Monitor Resetted\uFF0CPressing Keys Cleaned"}});return}let o=[];try{const a=JSON.parse(p),d={};a.forEach(n=>{d[n.keyName]||o.push({keyCode:n.keyCode,keyName:n.keyName,enKeyName:n.enKeyName,isKeydown:!0,isBlocked:!1}),d[n.keyName]=!0})}catch(a){this.sendMessage({type:"error",payload:{message:`\u89E3\u6790pressingKeycodes JSON\u5931\u8D25: ${a}`}}),o=[]}if(this.pressingKeys.length===o.length&&this.pressingKeys.every(a=>o.find(d=>d.keyCode===a.keyCode)))return;this.pressingKeys=o,this.lastKeysUpdateTime=Date.now(),this.sendMessage({type:"keyboard-event",payload:{pressingKeys:o,timestamp:Date.now()}})}catch{}}),!0),l.pointer(s))}catch(e){throw this.sendMessage({type:"error",payload:{message:`Failed to initialize keyboard monitor library: ${e?.message||e}`,stack:e?.stack}}),e}}setupMessageHandlers(){if(!process.send)throw new Error("This script must be run as a child process with IPC enabled");process.on("message",e=>{var s;try{switch(e.type){case"start":this.startMonitor((s=e.payload)==null?void 0:s.shortcuts);break;case"stop":this.stopMonitor();break;case"setTargetShortcuts":this.setTargetShortcuts(e.payload);break;case"resetPressingKeycodes":this.resetPressingKeycodes();break;case"setWatcherInterval":this.setWatcherInterval(e.payload);break;case"getKeyboardLayoutInfo":typeof e.payload=="object"&&e.payload!==null&&"requestId"in e.payload?this.getKeyboardLayoutInfo(e.payload.needDetail,e.payload.requestId):this.getKeyboardLayoutInfo(e.payload);break;case"destroy":this.destroy();break;default:this.sendMessage({type:"error",payload:{message:`Unknown message type: ${e.type}`}})}}catch(i){this.sendMessage({type:"error",payload:{message:`Error handling message: ${i?.message||i}`}})}}),process.on("disconnect",()=>{process.exit(0)}),process.on("SIGTERM",()=>{this.isMonitoring&&this.stopMonitor(),process.exit(0)}),process.on("SIGINT",()=>{this.isMonitoring&&this.stopMonitor(),process.exit(0)})}sendMessage(e){process.send&&process.send(e)}startMonitor(e){if(this.isMonitoring){this.sendMessage({type:"log",payload:{message:"Keyboard monitor is already running"}});return}try{if(e&&this.setTargetShortcuts(e),!this.libStartMonitor(this.callback)){this.sendMessage({type:"error",payload:{message:"Failed to start keyboard monitor"}});return}this.isMonitoring=!0,this.processEventsInterval=setInterval(()=>{try{this.libProcessEvents&&this.libProcessEvents();if(this.pressingKeys.length>0&&Date.now()-(this.lastKeysUpdateTime||0)>3000){this.resetPressingKeycodes();this.lastKeysUpdateTime=Date.now();}}catch(e){this.sendMessage({type:"error",payload:{message:"Keyboard processEvents error: "+e}})}},10),this.sendMessage({type:"status",payload:{isRunning:!0}}),this.sendMessage({type:"log",payload:{message:"Keyboard monitor started in child process"}})}catch(s){this.sendMessage({type:"error",payload:{message:`Error starting keyboard monitor: ${s}`}})}}stopMonitor(){if(!this.isMonitoring){this.sendMessage({type:"log",payload:{message:"Keyboard monitor is not running"}});return}try{this.processEventsInterval&&(clearInterval(this.processEventsInterval),this.processEventsInterval=null),this.libStopMonitor&&this.libStopMonitor(),this.isMonitoring=!1,this.pressingKeys=[],this.sendMessage({type:"status",payload:{isRunning:!1}}),this.sendMessage({type:"log",payload:{message:"Keyboard monitor stopped in child process"}})}catch(e){this.sendMessage({type:"error",payload:{message:`Error stopping keyboard monitor: ${e}`}})}}setTargetShortcuts(e){if(!this.libUpdateTargetShortcuts){this.sendMessage({type:"error",payload:{message:"Keyboard monitor library not initialized"}});return}try{const s=JSON.stringify(e);this.libUpdateTargetShortcuts(s),this.sendMessage({type:"log",payload:{message:`\u2705 \u8BBE\u7F6E\u591A\u7EC4\u5FEB\u6377\u952E: ${JSON.stringify(e)}`}})}catch(s){this.sendMessage({type:"error",payload:{message:`Error setting target shortcuts: ${s}`}})}}resetPressingKeycodes(){try{this.pressingKeys=[],this.libResetPressingKeycodes(),this.sendMessage({type:"keyboard-event",payload:{pressingKeys:this.pressingKeys,timestamp:Date.now()}})}catch(e){this.sendMessage({type:"error",payload:{message:`Error resetting pressing keycodes: ${e}`}})}}setWatcherInterval(e){if(e<=0){this.sendMessage({type:"error",payload:{message:`Watcher interval must be positive, got: ${e}`}});return}try{this.libSetWatcherInterval(e),this.sendMessage({type:"log",payload:{message:`Watcher interval set to: ${e} seconds`}})}catch(s){this.sendMessage({type:"error",payload:{message:`Error setting watcher interval: ${s}`}})}}getKeyboardLayoutInfo(e=!1,s){if(!this.libGetKeyboardLayoutInfo){this.sendMessage({type:"error",payload:{message:"Keyboard monitor library not initialized"}});return}try{const i=this.libGetKeyboardLayoutInfo(e),y=JSON.parse(i);s!==void 0?this.sendMessage({type:"keyboard-layout-info",payload:{layoutInfo:y,requestId:s}}):this.sendMessage({type:"keyboard-layout-info",payload:y})}catch(i){this.sendMessage({type:"error",payload:{message:`Error getting keyboard layout info: ${i}`}})}}destroy(){try{this.stopMonitor(),this.pressingKeys=[],this.callback=null,this.lib=null,this.libUpdateTargetShortcuts=null,this.libResetPressingKeycodes=null,this.libStartMonitor=null,this.libProcessEvents=null,this.libStopMonitor=null,this.libSetWatcherInterval=null,this.libGetKeyboardLayoutInfo=null}catch{}finally{process.exit(0)}}}try{new u,process.send&&process.send({type:"ready"})}catch(t){process.send&&process.send({type:"error",payload:{message:t?.message||String(t),stack:t?.stack}}),process.exit(1)}
